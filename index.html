<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Mass Anime Downloader - @Zebraslive</title>

    <link rel="stylesheet" type="text/css" href="./styles.css">
    <style>.downloadfile {
      width:125px !important;
    }.access_key_hold {    position: absolute;
    top: 31px;
    height: 94%;
    width: 100%;
    z-index: 4429485;
    background: rgba(27, 27, 27, 0.95);} .centerinputd {    margin: 0;
    position: absolute;
    top: 50%;
    left: 50%;
    -ms-transform: translate(-50%, -50%);
    transform: translate(-50%, -50%);} #access_key {text-align: center;} .access_btn{margin-top:5px;} .mceiaccess {display:none;} .searchbutton {outline: none;
    color: #d2d2d2;
    background-color: #2f3344d9;
    border-color: #464646;
    margin-bottom: 5px; float:none;} .scrape_url {display: none;} .current_series {display: none;}
.results_search > .item > .thumb {max-width: 55px;  display: inline-block; vertical-align: top;} .results_search > .item > .info {display: inline-block;} .results_search > .item {margin-top: 5px;   background: rgba(74, 78, 97, 0.72);} .more {display: none;} .mainboxxz {display: none;} .statsBoxcx {padding:10px; font-size:18px;} .nav-tabs{margin-left: 6px; margin-bottom: -4px !important;}
  </style>

  </head>
  <body>

   <div class="">
     <div id="title-bar-btns" style="-webkit-app-region: drag; display:block;">
       <span>Mass Anime Downloader</span>
          <div class="rightbuttons">
            <button id="min-btn" class="btn btn-default btn-sm"><i class="fa fa-window-minimize"></i></button>
          <button id="close-btn" class="btn btn-default btn-sm"><i class="fa fa-times"></i></button>
            </div>
     </div>

     </div>
     <div class="access_key_hold">

         <div class="centerinputd"><center>
<div class="loaderholdfii"><div class="loaderff_x"><div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>
 <div style="font-size: 24px; margin-top:5px;">Connecting...</div>
</div>
           <div class="mceiaccess">
             <div style="font-size: 24px; margin-bottom:5px;">Enter your access key</div>
               <input spellcheck="false" id="access_key" name="access_key" type="text" placeholder="XXXX_XXX_XXXX" class="form-control input" required="true">
               <div class="logmssg"></div>
               <div class="btn btn-default access_btn">Login</div>
               <div class="bottom_key_info" style="
      margin-top: 20px;
  ">
      <span class="text-mute"><a href="https://dinosaur.selly.store" title="https://dinosaur.selly.store" target="_blank">Click here to buy instant access key</a></span>
  </div></div>
             </center></div>
         </div>

<ul class="nav nav-tabs">
  <li class="" style="cursor:pointer;"><a data-toggle="modal" data-target="#myModal" aria-expanded="false">Search</a></li>
    <li class="active"><a data-toggle="tab" href="#home">Main</a></li>
    <li><a data-toggle="tab" href="#menu1">Debug</a></li>
    <li><a data-toggle="tab" href="#menu2">Settings</a></li>
  </ul>

  <div class="tab-content">
    <div id="home" class="tab-pane active">
     <div class="mainpadded">
<div class="subscriptions">

  <input class="scrape_url input input-sm form-control" type="text" placeholder="" value="">
</div>
<div class="current_series">
  <div class="seriesTitle">Selected Title: <span class="selected_title"></span></div>
</div>
<div class="startbuttons">
<button class="start btn btn-default">Grab Episodes</button>
    </div>
  <div class="updates">
	 Status: <span class="status">idle</span>
  </div>
             </div>
  <center><div class="loaderf"><div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></center>
  <div id="result"></div>
  <div class="timetx"></div>
    </div>
    <div id="menu1" class="tab-pane fade">
     Logs<br>
     <pre class="prelogs"></pre>
    </div>
    <div id="menu2" class="tab-pane fade">



<button class="btn btn-default btn-sm openConsole">Open Dev Tools</button>

<div>


</div>


      <div class="statsBoxcx">
<div class="bandwidthf"></div>
<div class="total_requests">Total Proxied requests: <span class="totalrfequesti">...</span></div>
      </div>
    </div>

  </div>
  <!-- Modal -->
  <div class="modal" id="myModal" role="dialog">
    <div class="modal-dialog">

      <!-- Modal content-->
      <div class="modal-content blok">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Search for Anime</h4>
        </div>
        <div class="modal-body">
          <button type="button" class="btn btn-default btn-md searchbutton">Search</button>
         <input class="searchInput input input-sm form-control" type="text" placeholder="" value="">
<div class="results_search">

  </div>
        </div>

      </div>

    </div>
  </div>
  <link rel="stylesheet" href="https://unpkg.com/izitoast/dist/css/iziToast.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script src="https://code.jquery.com/jquery-3.0.0.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/izitoast/dist/js/iziToast.min.js"></script>

<!-- Insert this line after script imports -->
<script>if (window.module) module = window.module;</script>
    <script>
      // You can also require other files to run in this process
      require('./renderer.js')
    </script>

<script>
  var request = require('request');
  const cheerio = require('cheerio');
const shell = require('electron').shell;
  var fs = require('fs');
  const app = require('electron').remote.app
  require('ssl-root-cas').inject();
var startDate;
function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 Bytes';

    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

    const i = Math.floor(Math.log(bytes) / Math.log(k));

    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}
function string_to_slug (str) {
    str = str.replace(/^\s+|\s+$/g, ''); // trimf
    str = str.toLowerCase();

    // remove accents, swap ñ for n, etc
    var from = "àáäâèéëêìíïîòóöôùúüûñç·/_,:;";
    var to   = "aaaaeeeeiiiioooouuuunc------";
    for (var i=0, l=from.length ; i<l ; i++) {
        str = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
    }

    str = str.replace(/[^a-z0-9 -]/g, '') // remove invalid cha
        .replace(/\s+/g, '-') // collapse whitespace and replace by -
        .replace(/-+/g, '-'); // collapse dashes

    return str;
}
function mp4upload(urlf) {
  var mxisisii = urlf.split('.com/')[1];
  if (mxisis.includes('embed-')) {
    var shuid = mxisis.split('embed-')[1];
    var mfidxsx = shuid.split('.html')[0];
  } else {
    var mfidxsx = mxisisii;
  }
  request.post({url:'https://www.mp4upload.com/'+mfidxsx, followRedirect: false, form: {op:'download2', id:mfidxsx}}, function(err,httpResponse,body){
    return httpResponse.headers.location;
});
}

$(function(){
var currentxx = [];
var socket = io.connect('https://bda.life:3000');
socket.on('connect', () => {
    var socketConnected;
    window.socketConnected = socket.connected;
    $('.loaderholdfii').remove();
    $('.mceiaccess').fadeIn(10);
});
function downloadFile(file_url , targetPath, progressElement){
    // Save variable to know progress
    var received_bytes = 0;
    var total_bytes = 0;

    var req = request({
        method: 'GET',
        uri: file_url,
        rejectUnauthorized: false,
      requestCert: true,
    });

    var out = fs.createWriteStream(targetPath);
    req.pipe(out);

    req.on('response', function ( data ) {
        // Change the total bytes value to get progress later.
        total_bytes = parseInt(data.headers['content-length' ]);

        if (data.statusCode === 200 || data.statusCode == 200) {
          progressElement.text(data.statusCode);
        } else {
          progressElement.text("Error wait for downloads to finish "+data.statusCode);
        }
    });
 progressElement.attr('status', 'downloading');
    req.on('data', function(chunk) {
        // Update the received bytes
        received_bytes += chunk.length;

        showProgress(received_bytes, total_bytes, progressElement);
    });
req.on('error', function(err) {
        $('.status').text('download failed '+err);
         progressElement.attr('status', 'waiting');
        progressElement.html('<span class="text-danger">retry</span>');
    });
    req.on('end', function() {
        var stats = fs.statSync(targetPath)
var fileSizeInBytes = stats["size"]
 if (fileSizeInBytes <= 9500) {
    progressElement.attr('status', 'waiting');
progressElement.html('<span class="text-danger">retry</span>');
} else {
  progressElement.attr('status', 'done');
progressElement.text('Done!');
}
    });
}
function truncf(decimal,n=1){
  let x = decimal + ''; // string
  return x.lastIndexOf('.')>=0?parseFloat(x.substr(0,x.lastIndexOf('.')+(n+1))):decimal; // You can use indexOf() instead of lastIndexOf()
}
function showProgress(received,total, progressElement){
    var percentage = (received * 100) / total;
    progressElement.html('<div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="'+truncf(percentage)+'"aria-valuemin="0" aria-valuemax="100" style="width:'+truncf(percentage)+'%">'+truncf(percentage)+'%</div></div>');
}

function output_episodes(data) {
    $('.loaderf').fadeOut(100);
    $('.start').text('Grab Episodes');
	    var dataff = "";
      var linksf = "";
	    for (var i = 0; i < data.length; i++){
        data[i].server = data[i].server.replace('?autostart=true','');
  dataff += data[i].server+'\n';
  linksf += "<button class='downloadfile btn btn-default' status='waiting' serverID='"+data[i].server+"' slugx='"+data[0].slug+"' filename='"+data[0].slug+"_episode_"+data[i].ep+".mp4' link='https://bda.life/api/mp4x2.php?u='>Episode "+data[i].ep+"</button>";
	    }
	$('#result').html('<div class="totals"></div><textarea class="form-control textarea mainboxxz">'+dataff+'</textarea><br>'+linksf);
   $('.downloadfile').click(function() {
     if ($(this).attr('status') === "done" || $(this).attr('status') === "downloading") {

     } else {
       downloadForce($(this));
     }

   });
$('textarea').val($('textarea').val().replace(/^(?=\n)$|^\s*|\s*$|\n\n+/gm,""));
var textx = $('.textarea').val();
	var linefs = textx.split(/\r|\r\n|\n/);
var countf = linefs.length;
$('.totals').html('Episodes Grabbed: '+countf);
//$('.status').html('Completed!');
stopTime();
}
function downloadForce(dthis) {
  var zonenzi = $('#zonename').val();
  var customerid = $('#customerid').val();
  var zonepass = $('#zonepass').val();
 var ziidiug = dthis.attr('serverID');
  var fileurl = dthis.attr('link');
  var slugiucu = dthis.attr('slugx');
  if (fs.existsSync(".\\anime_downloads\\"+slugiucu)) {
    // Do something
} else {
  fs.mkdirSync(".\\anime_downloads\\"+slugiucu, { recursive: true })
}
     var filename = dthis.attr('filename');
  var countryArray = new Array('us', 'ca');
  var randomCountry = countryArray[Math.floor(Math.random() * countryArray.length)];
    var timestampx = Math.floor(Date.now() / 1000);

      if (fileurl.includes('mp4upload')) { //already decoded.
         dthis.text("Starting");
         var mxisisii = fileurl.split('.com/')[1];
         if (mxisisii.includes('embed-')) {
           var shuid = mxisisii.split('embed-')[1];
           var mfidxsx = shuid.split('.html')[0];
         } else {
           var mfidxsx = mxisisii;
         }

      request.post({url:'https://www.mp4upload.com/'+mfidxsx, followRedirect: false, rejectUnauthorized: false, requestCert: true, form: {op:'download2', id:mfidxsx}}, function(err,httpResponse,body){
           var maindownloadurl = encodeURI(httpResponse.headers.location);
           if (maindownloadurl.includes('mp4upload')) {

             downloadFile(maindownloadurl, ".\\anime_downloads\\"+slugiucu+"\\"+filename, dthis);
           } else {
             console.log('error with grabbing url');
           }
       });

      } else {
        dthis.text("Decoding");
  var timestampxx = Math.floor(Date.now() / 1000);
  socket.emit('decode episode', ziidiug);

      }


}

function stopTime() {

  var startTime = startDate.getTime();
  var date_now = new Date();
  var time_now = date_now.getTime();
  var time_diff = time_now - startTime;
  var seconds_elapsed = Math.floor(time_diff / 1000);
  //$('.status').html('Completed in '+seconds_elapsed+' Seconds');
}

function start() {
  startDate = new Date();
}
$('.settings').click(function() {
  if ($(this).hasClass('isetx')) {
    $('.settings').removeClass('isetx');
$('.settingsBox').fadeOut(100);
  } else {
     $('.settings').addClass('isetx');
$('.settingsBox').fadeIn(100);
  }

});
$('.searchbutton').click(function() {
  var valuexx = $('.searchInput').val();
  socket.emit('search', valuexx);

  //searchAnime(valuexx);
});
socket.on('update usage stats', function(data) {
  console.log(data);
  if (data.data_used <= 0) {

  } else {
    data.data_used = formatBytes(data.data_used);
  }
  $('.bandwidthf').html('<div>Max data transfer: <span class="maxtransferdata">'+formatBytes(data.max_data)+'</span></div><div>Data used: <span class="datausedx">'+data.data_used+'</span></div>');
  $('.totalrfequesti').html(data.total_requests);
});
socket.on('decoded episode', function(code, body, hash) {
  socket.emit('update stats');
      var dthis = $('.downloadfile[serverID="'+hash+'"]');
      var slugiucu = dthis.attr('slugx');
         var filename = dthis.attr('filename');
  if (body.includes('Our firewall temporarily blocks your IP in 1 hour')) {

     dthis.html('<span class="text-danger">retry</span>');
     dthis.attr('status', 'waiting');
  $('.status').html('Ip blocked, try again');
        return false;
      }
         var izhgixx = JSON.parse(body);
           //console.error('error:', error); // Print the error if one occurred

         if (code === 200 && typeof izhgixx.target !== "undefined" && izhgixx.target.includes('mp4upload')) {

  dthis.attr('link', izhgixx.target);
  var mxisisii = izhgixx.target.split('.com/')[1];
  if (mxisisii.includes('embed-')) {
    var shuid = mxisisii.split('embed-')[1];
    var mfidxsx = shuid.split('.html')[0];
  } else {
    var mfidxsx = mxisisii;
  }

  request.post({url:'https://www.mp4upload.com/'+mfidxsx, followRedirect: false, rejectUnauthorized: false, requestCert: true, form: {op:'download2', id:mfidxsx}}, function(err,httpResponse,body){
       var maindownloadurl = encodeURI(httpResponse.headers.location);
    if (maindownloadurl.includes('mp4upload')) {

      downloadFile(maindownloadurl, ".\\anime_downloads\\"+slugiucu+"\\"+filename, dthis);
    } else {
      console.log('error with grabbing url');
    }
  });



         dthis.text("Starting");
         } else {
           dthis.attr('status', 'waiting');
           dthis.html('<span class="text-danger">retry</span>');
         }
});
socket.on('search_results', function(data) {
//  console.log('search results output '+data);
  socket.emit('update stats');
   $('.results_search').html(data);
   $('a.name').each(function() {
     var teihxi = $(this).text();
     var idlink = $(this).attr('href');
     $(this).replaceWith('<div><div style="display: inline-block;">'+teihxi+'</div> <div class="btn btn-default seriesGrabbb" title="'+teihxi+'" link="'+idlink+'">Grab</div></div>');
   });
  $('.seriesGrabbb').click(function() {
  var valudiig = $(this).attr('link');
  var titleih = $(this).attr('title');
  $('.selected_title').html(titleih);
  $('.scrape_url').val(valudiig);
  $('.current_series').fadeIn(10);
  $('#myModal').modal('hide');
  $('.status').html('Click grab episodes button');
  });
});

$('.start').click(function() {
  var dataxx = $('.scrape_url').val();
if (dataxx.length > 6) {
start();
socket.emit('grab episodes', dataxx);
//grabEpisodes(dataxx);
 $('.loaderf').fadeIn(100);
 if ($(this).hasClass('closeb')) {
   $(this).removeClass('closeb');
$(this).text('Start');
return false;
 } else {
   $(this).addClass('closeb');
$(this).text('Running');
 }
} else {
$('.status').html('Error, Select a series from Search to grab episodes');
}





});

$(document).on('click', 'a[href^="http"]', function(event) {
    event.preventDefault();
    shell.openExternal(this.href);
});
$('.access_btn').click(function() {
  $(this).text('Loading...');
  var keyval = $('#access_key').val().trim();
  socket.emit('open the gate', keyval);

});
socket.on('episodes grabbed', function(episodes) {
  $('.status').html('Click on episodes below to download');
    output_episodes(episodes);
});
socket.on('access granted 007', function(data) {
  if (data.data_used <= 0) {

  } else {
    data.data_used = formatBytes(data.data_used);
  }
  $('.bandwidthf').html('<div>Max data transfer: <span class="maxtransferdata">'+formatBytes(data.max_data)+'</span></div><div>Data used: <span class="datausedx">'+data.data_used+'</span></div>');
  $('.totalrfequesti').html(data.total_requests);
  var keyvfal = $('#access_key').val().trim();
  fs.writeFile('./p_k.txt', keyvfal, function (err) {
  if (err) throw err;
  console.log('Saved key!');
});
$('.access_key_hold').remove();
});
socket.on('access denied', function(data) {
$('.logmssg').html('<span class="text-danger">Error: '+data+'</span>');
$('.access_btn').text('Login');
});

socket.on('status', function(data) {
$('.status').html(data);
$('.prelogs').prepend("\n"+data);
});

 // iziToast.info({position: "center", title: 'Hello', message: 'iziToast.info()'});
 //   iziToast.success({timeout: 5000, icon: 'fa fa-chrome', title: 'OK', message: 'iziToast.sucess() with custom icon!'});
 //   iziToast.warning({position: "bottomRight", title: 'Caution', message: '日本語環境のテスト'});
 // iziToast.error({title: 'Error', message: 'Illegal operation'});
});

const randomString = () => {
	const alphanumeric = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
	let res = '';
	for (let i = 0; i < 10; i++) {
		res += alphanumeric.charAt(Math.floor(Math.random() * alphanumeric.length));
	}
	return res;
}
</script>

  </body>
</html>
